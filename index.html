<script>
(function() { // ä½¿ç”¨ IIFE é¿å…è®Šæ•¸æ±¡æŸ“ï¼Œä½†å°‡æ ¸å¿ƒåŠŸèƒ½æ›è¼‰åˆ° window

  console.log("ğŸš€ Supabase é›²ç«¯æ¨¡çµ„å•Ÿå‹•ä¸­...");

  // 1. å®šç¾©å…¨åŸŸè®Šæ•¸
  window.saveTimeout = null;

  // 2. å®šç¾©å„²å­˜åŠŸèƒ½ (æ ¸å½ˆç´šå¯«æ³•ï¼šç›´æ¥æ›è¼‰ window)
  window.saveToCloud = async function() {
    // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return; // æœªç™»å…¥ä¸åŸ·è¡Œ

    // é˜²æŠ–å‹•è¨­è¨ˆ
    clearTimeout(window.saveTimeout);
    window.saveTimeout = setTimeout(async () => {
      console.log("â˜ï¸ æ­£åœ¨åŒæ­¥åˆ°é›²ç«¯...");
      
      // å˜—è©¦ç²å–å…¨åŸŸæ•¸æ“š (å…¼é¡§ä¸åŒå¯«æ³•)
      let currentCritiques = [];
      let currentCommonTypos = [];
      
      try { if (typeof critiques !== 'undefined') currentCritiques = critiques; } catch(e) {}
      try { if (typeof commonTypos !== 'undefined') currentCommonTypos = commonTypos; } catch(e) {}

      const updates = {
        id: user.id,
        critiques: currentCritiques,
        common_typos: currentCommonTypos,
        updated_at: new Date(),
      };

      const { error } = await supabase.from('users_data').upsert(updates);
      
      // UI åé¥‹
      const emailSpan = document.getElementById('user-email');
      if (error) {
        console.error('âŒ å„²å­˜å¤±æ•—:', error);
        if(emailSpan) emailSpan.textContent = "âŒ å„²å­˜å¤±æ•—";
      } else {
        console.log('âœ… å„²å­˜æˆåŠŸ');
        if(emailSpan) {
            const originalText = user.email;
            emailSpan.textContent = "âœ… å·²å„²å­˜";
            setTimeout(() => { 
                 // åªæœ‰ç•¶æ–‡å­—é‚„æ²’è®Šå…¶ä»–é‡å€‹é™£å…ˆè®Šå› Email
                 if(document.getElementById('user-email').textContent === "âœ… å·²å„²å­˜") {
                     emailSpan.textContent = originalText; 
                 }
            }, 2000);
        }
      }
    }, 1000);
  };

  // 3. å®šç¾©ç™»å…¥åŠŸèƒ½
  window.login = async function() {
    const email = prompt("è«‹è¼¸å…¥ Email ä»¥ç²å–ç™»å…¥é€£çµ (Magic Link):");
    if (!email) return;
    
    const { error } = await supabase.auth.signInWithOtp({
      email: email,
      options: { emailRedirectTo: window.location.href }
    });

    if (error) alert("ç™»å…¥éŒ¯èª¤: " + error.message);
    else alert("ğŸ“§ é€£çµå·²å¯„å‡ºï¼è«‹æª¢æŸ¥ Email (åŒ…æ‹¬åƒåœ¾éƒµä»¶)ã€‚");
  };

  // 4. å®šç¾©ç™»å‡ºåŠŸèƒ½
  window.logout = async function() {
    await supabase.auth.signOut();
    window.location.reload();
  };

  // 5. å®šç¾©è¼‰å…¥åŠŸèƒ½
  window.loadCloudData = async function(userId) {
    const emailSpan = document.getElementById('user-email');
    if(emailSpan) emailSpan.textContent = "è³‡æ–™åŒæ­¥ä¸­...";

    const { data, error } = await supabase
      .from('users_data')
      .select('critiques, common_typos')
      .eq('id', userId)
      .single();

    if (data) {
      console.log("ğŸ“¥ é›²ç«¯è³‡æ–™ä¸‹è¼‰æˆåŠŸ");
      // æ›´æ–°å…¨åŸŸè®Šæ•¸
      if (data.critiques) {
          window.critiques = data.critiques; // å¼·åˆ¶æ›´æ–°å…¨åŸŸ
          if (typeof renderCritiqueList === 'function') renderCritiqueList();
      }
      if (data.common_typos) {
          window.commonTypos = data.common_typos;
          if (typeof renderCommonTypoList === 'function') renderCommonTypoList();
      }
    }
    
    // æ¢å¾© Email é¡¯ç¤º
    const { data: { user } } = await supabase.auth.getUser();
    if(user && emailSpan) emailSpan.textContent = user.email;
  };

  // 6. åˆå§‹åŒ– & ç›£è½å™¨ (ç¶²é è¼‰å…¥å¾ŒåŸ·è¡Œ)
  document.addEventListener('DOMContentLoaded', async () => {
      
      // A. ç¶å®šæŒ‰éˆ• (é˜²æ­¢ HTML onclick å¤±æ•ˆ)
      const btnLogin = document.getElementById('btn-login');
      const btnLogout = document.getElementById('btn-logout');
      if(btnLogin) {
          btnLogin.onclick = window.login; // ç›´æ¥è¦†è“‹é»æ“Šäº‹ä»¶
          btnLogin.style.display = 'block'; // é è¨­é¡¯ç¤º
      }
      if(btnLogout) {
          btnLogout.onclick = window.logout;
          btnLogout.style.display = 'none'; // é è¨­éš±è—
      }

      // B. ç›£è½ Supabase ç™»å…¥ç‹€æ…‹
      supabase.auth.onAuthStateChange(async (event, session) => {
        const user = session?.user;
        const emailSpan = document.getElementById('user-email');

        if (user) {
          // === å·²ç™»å…¥ ===
          if(btnLogin) btnLogin.style.display = 'none';
          if(btnLogout) btnLogout.style.display = 'inline-block';
          if(emailSpan) {
            emailSpan.style.display = 'inline-block';
            emailSpan.textContent = user.email;
          }
          // è¼‰å…¥è³‡æ–™
          await window.loadCloudData(user.id);
        } else {
          // === æœªç™»å…¥ ===
          if(btnLogin) btnLogin.style.display = 'inline-block';
          if(btnLogout) btnLogout.style.display = 'none';
          if(emailSpan) emailSpan.style.display = 'none';
        }
      });

      // C. å…¨åŸŸæ‰“å­—ç›£è½ (æœ€å¼·åŠ›çš„è‡ªå‹•å„²å­˜)
      document.body.addEventListener('input', function(e) {
          // åªè¦ä¸æ˜¯ç™»å…¥æ¡†çš„è¼¸å…¥ï¼Œéƒ½è§¸ç™¼å„²å­˜
          if(e.target.id !== 'user-email') {
              window.saveToCloud();
          }
      });

      // D. æ””æˆªèˆŠæœ‰å„²å­˜å‡½æ•¸ (é›™é‡ä¿éšª)
      if(typeof window.persistCritiques !== 'undefined') {
          const oldFn = window.persistCritiques;
          window.persistCritiques = function() {
              oldFn.apply(this, arguments);
              window.saveToCloud();
          }
      }
  });

})();
</script>
</body>
</html>
